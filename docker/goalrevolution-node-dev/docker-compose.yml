version: '3'
services:
  ethereum: 
    image: freeverseio/parity:v2.7.2-posdao-stable
    command: --min-peers 10 --max-peers 30
    volumes:
      - ethereum-data:/home/parity/.local/share/io.parity.ethereum
  ipfs.node:
    image: ipfs/go-ipfs:v0.5.0
    restart: always
    environment:
      - IPFS_PATH=/data
      # - IPFS_FD_MAX=4096
      # - IPFS_PROFILE=test
    volumes:
      - ipfs.node-data:/data
  ipfs.cluster:
    image: ipfs/ipfs-cluster:v0.12.1
    restart: always
    entrypoint: ["ipfs-cluster-follow"]
    environment: 
      CLUSTER_IPFSHTTP_NODEMULTIADDRESS: /dns4/ipfs.node/tcp/5001
      CLUSTER_RESTAPI_HTTPLISTENMULTIADDRESS: /ip4/0.0.0.0/tcp/9094
      CLUSTER_IPFSPROXY_LISTENMULTIADDRESS: /ip4/0.0.0.0/tcp/9095
      CLUSTER_IPFSPROXY_NODEMULTIADDRESS: /dns4/ipfs.node/tcp/5001
    command: gr-ipfs-cluster run --init https://ipfs.io/ipns/goalrevolution.collab.ipfs.cluster.io.gorengine.com
    depends_on: 
      - ipfs.node
    volumes:
      - ipfs.cluster-data:/data
  universe.db:
    image: "freeverseio/universe.db:${TAG}"
    restart: always
    volumes:
      - universe.db-data:/var/lib/postgresql/data
  synchronizer:
    image: "freeverseio/synchronizer:${TAG}"
    # build: 
    #   context: ../../go/
    #   dockerfile: Dockerfile.synchronizer
    restart: always
    command: > 
      -postgres postgres://freeverse:freeverse@universe.db:5432/cryptosoccer?sslmode=disable 
      -ipfs /dns4/ipfs.node/tcp/5001
      -ethereum http://ethereum:8545
      -proxy_address "${PROXY_CONTRACT_ADDRESS}"
      -staker "${STAKER_PVC}"
      -delta "${BLOCKS_PER_STEP}"
      # -debug
    depends_on:
      - universe.db
      - ethereum
      - ipfs.node
      - ipfs.cluster
  universe.api:
    image: "freeverseio/universe.api:${TAG}"
    depends_on:
      - ethereum
    command: >
      -d postgres://freeverse:freeverse@universe.db:5432/cryptosoccer 
      --enableCors true
  market.db:
    image: freeverseio/market.db:$TAG
  market.trader:
    image: freeverseio/market.trader:$TAG
    command: -d postgres://freeverse:freeverse@market.db:5432/market -p 4000
  market.notary:
    image: freeverseio/market.notary:$TAG
    depends_on:
      - ethereum
    command: >
      -postgres postgres://freeverse:freeverse@market.db:5432/market?sslmode=disable  
      -private_key "3B878F7892FBBFA30C8AED1DF317C19B853685E707C2CF0EE1927DC516060A54" 
      -ethereum http://ethereum:8545 
      -market_address "${MARKET_CONTRACT_ADDRESS}" 
  horizon:
    # image: freeverseio/horizon:$TAG
    build: 
      context: ../../nodejs-horizon/
    depends_on:
      - universe.api
      - market.trader
    command: >
      -u http://universe.api:4000/graphql 
      -m http://market.trader:4000/graphql 
    ports:
      - "4000:4000"

volumes:
  ethereum-data:
  ipfs.node-data:
  ipfs.cluster-data:
  universe.db-data:

